server {
    listen 80;
    server_name $SERVER_NAME;

    # --- static site (Vite build) ---
    root /usr/local/var/www/$SERVER_NAME;
    index index.html;

    location / {
        try_files $uri /index.html;
        # Keep index.html non-immortal so updates are picked up
        add_header Cache-Control "no-cache";
    }

    location /assets/ {
        try_files $uri =404;
        access_log off;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # health check
    location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

    # ---------- API -> Ollama ----------
    location ^~ /api/ {
        # Handle browser preflight here so Ollama never sees OPTIONS
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Credentials true always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,PATCH,OPTIONS" always;
            add_header Vary "Origin" always;
            return 204;
        }

        # CORS headers on actual requests (harmless for same-origin)
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Vary "Origin" always;

        proxy_http_version 1.1;

        # Make Ollama think this is local to avoid 403s
        proxy_set_header Host 127.0.0.1:11434;
        proxy_set_header X-Real-IP 127.0.0.1;
        proxy_set_header X-Forwarded-For 127.0.0.1;

        proxy_buffering off;            # donâ€™t buffer upstream response
        proxy_request_buffering off;    # stream request body to upstream immediately
        proxy_cache off;
        gzip off;                       # gzip can delay streaming; disable for this location
        add_header X-Accel-Buffering no;

        # allow long-running streams / slower Wi-Fi
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        send_timeout 3600s;
        client_body_timeout 3600s;

        # optional: larger prompts/files
        client_max_body_size 64m;

        # Important: do NOT set `proxy_set_header Origin ...`
        # Pass the path through unchanged
        proxy_pass http://127.0.0.1:11434;
    }

}
